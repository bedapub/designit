---
title: "On the necessity of experiment design: a generative modelling approach"
author: "Jitao david Zhang"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Necessity of experiment design}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

In this document, we demonstrate the necessity of a proper experiment design 
with a generative model. We show that a proper experiment design helps
experimentalists and analysts make correct inference about the quantity of 
interest that is robust against randomness.

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo = FALSE}
library(designit)
library(tidyverse)
```

# The simplest case

Assume we perform an experiment to test the effect of eleven drug candidates under development on cell viability. To do so, we treat cells in culture with a fixed concentration of each of the elevent candidates, and we treat cells with DMSO (dimethyl sulfoxide) as a vehicle control, since the drug candidates are all solved in DMSO solutions. 

To assess the effect with regard to the variability intrinsic to the experiment setup, we measure the effect of each drug candidate (and DMSO) in eight different batches of cells, which are comparable to each other.

In total, we have 96 samples: 11 drug candidates plus one DMSO control, 8 samples each. The samples fit neatly into a 96-well microtiter plate with 8 rows, which are usually marked with alphabets between `A` and `H`, and 12 columns, which are usually marked with numbers betwen 1 and 12.

In order to avoid batch effects and to make the operation simple, all operations and measurements are done by the same careful person and performed all at once. The operator has two possibilities:

1. She does not randomize the samples with regard to the plate layout. The naive layout will put each drug candidate or DMSO in one column. For simplicity, let us assume that the cells treated with DMSO are put in column 1, and cells treated with the eleven drug candidates are put in columns 2 to 12.
2. She randomizes the samples with regard to the plate layout, so that nearby samples are not necessarily of the same condition.

What is the difference between the two variants? Option 2 apparently involves more planning and labor than option 1. If manual instead of robotic pipetting is involved, option 2 is likely error-prone. So why bothering considering the later option?

Randomization pays off when unwanted variance is large enough so that it may distort our estimate of the quantity in which we are interested in. For instance, in our example, the unwanted variance may come from the *plate effect*: due to variances in temperature, humidity, and evaporation between wells in the plate, cells may respond differently to *even the same treatment*. Such *plate effects* are difficult to judge practically because they are not known prior to the experiment, unless a calibration study is performed where the cells in a microtiter plate are indeed treated with the same condition and measurements are performed in order to quantify the plate effect. However, it is simple to *simulate* such plate effects *in silico* with *a generative model*, and test the effect of randomization.

```{r}
set.seed(2307111)

dat <- data.frame(SampleIndex=1:96,
                  Compound=gl(12, 8, 
                              labels=c("DMSO", paste0("Compound", 1:11))),
                  NaiveRow=rep(1:8, 12),
                  NaiveCol=rep(1:12, each=8))
bc <- BatchContainer$new(
  dimensions = list("plate" = 1, "row" = 8, "col" = 12),
)

assign_in_order(bc, dat)

head(bc$get_samples()) %>% gt::gt()
```

