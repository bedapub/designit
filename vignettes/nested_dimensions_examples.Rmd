---
title: "Basic examples"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Basic examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(designit)
library(tidyverse)
```


# Sample annotation overview

```{r}
data("multi_trt_day_samples")
```

Samples are grouped by Treatment and Time with the following group sizes:

```{r}
multi_trt_day_samples %>% count(Time, Treatment) %>% 
  gt::gt()
```

Total number of samples is: `r nrow(multi_trt_day_samples)`

Samples are to be blocked in batches for scRNA-seq. 
8 samples can be processed per day-batch and are split into 2 parallel runs (4 + 4). 

# Batch optimization

```{r}
# Setting up the batch container
bc <- BatchContainer$new(
  dimensions = c(batch = ceiling(nrow(multi_trt_day_samples) / 8), 
                 run=2, position=4)
)

# Add samples to container
bc$samples_df <- multi_trt_day_samples
# Initial random assignment
assign_in_order(bc)

bc
```

The samples are distributed to 4 batches (processing days).
This is done using osat scoring on sample `Treatment` and `Time`, optimizing by shuffling.

```{r}
n_shuffle <- rep(c(32, 10, 5, 2), c(100, 100, 300, 500)) 
n_iterations <- length(n_shuffle)

set.seed(42) # should we have conventions for this?

# Set scoring function
bc$scoring_f <- function(samples) osat_score(samples, c("batch"), c("Treatment", "Time"))$score

# initial score
#bc$score()
trace <- assign_score_optimize_shuffle(
   bc,
   n_shuffle = n_shuffle, 
   # This is added to reduce the search space: 
   # BUT THEN IT DOES NOT REACH OPTIMAL SOLUTION
   # shuffle_proposal = shuffle_with_constraints(
   #  src = TRUE,
   #  # batch needs to change for shuffle to be accepted
   #  dst=.src$batch != batch
   # ),
   iterations = n_iterations) # default is 1000?
```

## Optimization trace {.tabset}

### hide
### show

```{r, fig.width=5, fig.height= 4}
qplot(x = 1:n_iterations, y = trace, color = factor(n_shuffle), 
      main = str_glue("Final score={bc$score()}"), geom = "point")
```

## Final batch layout
```{r}
bc$get_samples(assignment = TRUE) %>%
  mutate(batch = factor(batch)) %>% 
  ggplot(aes(x = batch, fill =  Treatment, alpha = factor(Time))) + 
  geom_bar()

```


# Within batch runs 

Using shuffle with constraints

Within each day there will be 2 runs (samples processed together) with 4 samples each. 
For this we keep the optimized `batch` and now only optimize `run` with constraint.

```{r}
n_shuffle <- rep(c(32, 10, 5, 2), c(50, 50, 100, 200)) 
n_iterations <- length(n_shuffle)

trace_run <- assign_score_optimize_shuffle(
  bc,
  n_shuffle = n_shuffle,
  shuffle_proposal = shuffle_with_constraints(
    src = TRUE,
    # batch remains the same and run needs to change
    dst = batch == .src$batch & run != .src$run
  ),
  iterations = n_iterations
)
```

"no shuffling proposed, stopping the optimization" ? But is actually does something?

```{r, fig.width=5, fig.height= 4}
qplot(x = 1:n_iterations, y = trace_run, color = factor(n_iterations), 
      main = str_glue("Final score={bc$score()}"), geom = "point")
```


## Final batch layout
```{r}
bc$get_samples(assignment = TRUE) %>%
  mutate(batch = factor(batch)) %>% 
  ggplot(aes(x = batch, fill =  Treatment, alpha = factor(Time))) + 
  geom_bar()

bc$get_samples() %>% 
 mutate(run = factor(run)) %>% 
  ggplot(aes(x = run, fill =  Treatment, alpha = factor(Time))) + 
  geom_bar() +
  facet_wrap(~batch)

```

# Optimize in one go? Not working 

```{r}
# Setting up the batch container
bc <- BatchContainer$new(
  dimensions = c(batch = ceiling(nrow(multi_trt_day_samples) / 8), 
                 run=2, position=4)
)

# Add sample_sheet to container
bc$samples_df <- multi_trt_day_samples
# Initial random assignment
assign_random(bc)

bc
```

The samples are distributed to 4 batches (processing days).
This is done using osat scoring on sample `Treatment` and `Time`, optimizing by shuffling.

```{r}
n_shuffle <- rep(c(32, 10, 5, 2), c(100, 100, 300, 500)) 
#n_shuffle <- rep(c(32, 10, 5, 2), c(50, 50, 50, 200)) 
n_iterations <- length(n_shuffle)

set.seed(42) # should we have conventions for this?

# Set scoring function
bc$scoring_f <- function(samples) osat_score(samples, c("batch", "run"), c("Treatment", "Time"))$score

# initial score
#bc$score()
trace2 <- assign_score_optimize_shuffle(bc, 
                                       n_shuffle = n_shuffle, 
                                       iterations = n_iterations) # can we simplify?
# final score
#bc$score()
```

## Optimization trace {.tabset}

### hide
### show

```{r, fig.width=5, fig.height= 4}
qplot(x = 1:n_iterations, y = trace2, color = factor(n_shuffle), 
      main = str_glue("Final score={bc$score()}"), geom = "point")
```

## Final batch layouts
```{r}
bc$get_samples(assignment = TRUE) %>%
  mutate(batch = factor(batch)) %>% 
  ggplot(aes(x = batch, fill =  Treatment, alpha = factor(Time))) + 
  geom_bar()


bc$get_samples() %>% 
 mutate(run = factor(run)) %>% 
  ggplot(aes(x = run, fill =  Treatment, alpha = factor(Time))) + 
  geom_bar() +
  facet_wrap(~batch)
```

