---
output: github_document
editor_options: 
  chunk_output_type: console
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# designit

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
<!-- badges: end -->

The goal of designit is to ... **TODO** fill this!

## skeleton

* a metric of how balanced?
* check ^2 and ^3, it should be different (3 better)

### algorithm

- generate formula
  - .^m m = number of factors
  - check model.matrix
  - check how many to remove, and what order
  - if one order is not complete, then do random draw from that?
  - or use optMonteCarlo <-- this doesn't work
- optFederov
- optBlock
- rename Block and levels
- do it again

**should we support more than 2 levels?**

**what to do with numeric covariates**


```{r}
a <- readxl::read_excel('inst/extdata/CEA-PRIT_CEAmodels_for randomization.xlsx')
```


## Installation

TODO

## Example
```{r message=FALSE}
library(designit)
# define samples data.frame
samples <- data.frame(a='a', b=letters[1:3], c=c('b', 'b', 'c'))
samples

bc <- BatchContainer$new(
  dimensions = list(
    "plate" = 3,
    "row" = list(values = letters[1:3]),
    "column" = list(values = c(1, 3))
  ),
  exclude = data.frame(plate = 1, row = "a", column = c(1, 3), stringsAsFactors = F)
)

bc

bc$exclude
bc$n_locations
bc$n_excluded
bc$n_available
bc$locations_df

bc$distribute_samples(samples, random_seed=1)

head(bc$get_samples())
bc$get_samples(remove_empty_locations=TRUE)

# You can reassign samples starting from the current assignment.
bc$distribute_samples(random_seed=2)
head(bc$get_samples())

# Results should be reproducible if the seed is set.
bc$distribute_samples(random_seed=1)
bc$get_samples(remove_empty_locations=TRUE)
```

### Plate layout two factors

TODO: move to vignette once there

Samples of a 2-condition experiment in several animals are to be
placed on 2 48 well plates.

These are the conditions

```{r}

# conditions to use
conditions <- data.frame(group = c(1, 2, 3, 4, 5),
                      treatment = c("vehicle", "TRT1", "TRT2",
                                    "TRT1", "TRT2"),
                      dose = c(0, 25, 25, 50, 50))

kable(conditions)
```

We will have 3 animals per groups with 4 replicates each

```{r}
# sample table (2 animals per group with 3 replicates)
n_reps <- 4
n_animals <- 3
samples <- dplyr::bind_rows(replicate(n_animals, conditions, simplify = FALSE), .id = 'animal') 
samples <- dplyr::bind_rows(replicate(n_reps, samples, simplify = FALSE), .id = 'replicate') %>%
  dplyr::mutate(SampleID = paste0(treatment,'_',animal,'_',replicate),
                AnimalID = paste0(treatment,'_',animal))

DT::datatable(samples)
```

Corner wells of the plates should be left empty

```{r}
# to be put on a 48 well plate
# (empty wells: first and last column plus two more wells)
exclude_wells <- expand.grid(plate = 1:2, column = c(1,8), row = c(1,6))
```

Create a BatchContainer object that provides all possible locations

```{r}
bc <- BatchContainer$new(
  dimensions=c('plate' = 2, 'row' = 6, 'column' = 8),
  exclude=exclude_wells
)
bc

bc$n_available
bc$exclude
```

Randomly assign samples to the plate locations

```{r}
design <- distribute_samples(samples = samples, batch_container = bc, 
                             distribution_function = distribute_random, random_seed = 42)

DT::datatable(design)
```

Plot of the result

```{r}
library(ggplot2)
design %>% 
  ggplot(aes(x = factor(column), y = factor(-row), fill = treatment, alpha = factor(dose))) + 
  geom_tile() +
  facet_wrap(~plate) + 
  theme_bw() 
  
```



```{r}
library(tidyverse)
x <- expand.grid(b = paste0('b', 1:4),
                 a = LETTERS[1:4]) %>% 
  slice(-3:-4)
```


Example dataset:

Cell: 5 levels (A, B, C, D, E)
Trt: 2 levels (N, T)
Time: 2 levels (24, 48)

2 batches:
Extract: 5 levels (1-5)
Prep: 2 levels (1-2)

all combinations, 80 expt
