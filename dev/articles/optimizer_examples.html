<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Optimizer examples • designit</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Optimizer examples">
<meta property="og:description" content="designit">
<meta property="og:image" content="https://bedapub.github.io/designit/logo.svg">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">designit</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.4.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/NCS22_talk.html">designit: a flexible engine to generate experiment layouts</a>
    </li>
    <li>
      <a href="../articles/basic_examples.html">Basic example</a>
    </li>
    <li>
      <a href="../articles/custom_shuffle.html">Using custom shuffle schedule</a>
    </li>
    <li>
      <a href="../articles/invivo_study_design.html">In-vivo study design</a>
    </li>
    <li>
      <a href="../articles/nested_dimensions_examples.html">Nested dimension example</a>
    </li>
    <li>
      <a href="../articles/optimizer_examples.html">Optimizer examples</a>
    </li>
    <li>
      <a href="../articles/osat.html">OSAT and scoring functions</a>
    </li>
    <li>
      <a href="../articles/plate_layouts.html">Plate layouts</a>
    </li>
    <li>
      <a href="../articles/plate_scoring_examples.html">Plate scoring examples</a>
    </li>
    <li>
      <a href="../articles/shuffling_with_constraints.html">Shuffling with constraints</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/BEDApub/designit" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Optimizer examples</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/BEDApub/designit/tree/main/vignettes/optimizer_examples.Rmd" class="external-link"><code>vignettes/optimizer_examples.Rmd</code></a></small>
      <div class="hidden name"><code>optimizer_examples.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bedapub.github.io/designit/">designit</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="sample-annotation-overview">Sample annotation overview<a class="anchor" aria-label="anchor" href="#sample-annotation-overview"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"multi_trt_day_samples"</span><span class="op">)</span></span></code></pre></div>
<p>Samples are grouped by Treatment and Collection time with the
following group sizes:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multi_trt_day_samples</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">Time</span>, <span class="va">Treatment</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">gt</span><span class="fu">::</span><span class="fu"><a href="https://gt.rstudio.com/reference/gt.html" class="external-link">gt</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div id="cwbhcfrvkl" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#cwbhcfrvkl .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#cwbhcfrvkl .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#cwbhcfrvkl .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#cwbhcfrvkl .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#cwbhcfrvkl .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#cwbhcfrvkl .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#cwbhcfrvkl .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#cwbhcfrvkl .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#cwbhcfrvkl .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#cwbhcfrvkl .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#cwbhcfrvkl .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#cwbhcfrvkl .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#cwbhcfrvkl .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#cwbhcfrvkl .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#cwbhcfrvkl .gt_from_md > :first-child {
  margin-top: 0;
}

#cwbhcfrvkl .gt_from_md > :last-child {
  margin-bottom: 0;
}

#cwbhcfrvkl .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#cwbhcfrvkl .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#cwbhcfrvkl .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#cwbhcfrvkl .gt_row_group_first td {
  border-top-width: 2px;
}

#cwbhcfrvkl .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#cwbhcfrvkl .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#cwbhcfrvkl .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#cwbhcfrvkl .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#cwbhcfrvkl .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#cwbhcfrvkl .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#cwbhcfrvkl .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#cwbhcfrvkl .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#cwbhcfrvkl .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#cwbhcfrvkl .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#cwbhcfrvkl .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#cwbhcfrvkl .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#cwbhcfrvkl .gt_left {
  text-align: left;
}

#cwbhcfrvkl .gt_center {
  text-align: center;
}

#cwbhcfrvkl .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#cwbhcfrvkl .gt_font_normal {
  font-weight: normal;
}

#cwbhcfrvkl .gt_font_bold {
  font-weight: bold;
}

#cwbhcfrvkl .gt_font_italic {
  font-style: italic;
}

#cwbhcfrvkl .gt_super {
  font-size: 65%;
}

#cwbhcfrvkl .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

#cwbhcfrvkl .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#cwbhcfrvkl .gt_indent_1 {
  text-indent: 5px;
}

#cwbhcfrvkl .gt_indent_2 {
  text-indent: 10px;
}

#cwbhcfrvkl .gt_indent_3 {
  text-indent: 15px;
}

#cwbhcfrvkl .gt_indent_4 {
  text-indent: 20px;
}

#cwbhcfrvkl .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="table gt_table">
<thead class="gt_col_headings"><tr>
<th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Time">Time</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="Treatment">Treatment</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="n">n</th>
    </tr></thead>
<tbody class="gt_table_body">
<tr>
<td headers="Time" class="gt_row gt_right">4</td>
<td headers="Treatment" class="gt_row gt_left">CTRL</td>
<td headers="n" class="gt_row gt_right">3</td>
</tr>
<tr>
<td headers="Time" class="gt_row gt_right">4</td>
<td headers="Treatment" class="gt_row gt_left">SOC_TRT1</td>
<td headers="n" class="gt_row gt_right">4</td>
</tr>
<tr>
<td headers="Time" class="gt_row gt_right">4</td>
<td headers="Treatment" class="gt_row gt_left">SOC_TRT1_TRT2</td>
<td headers="n" class="gt_row gt_right">3</td>
</tr>
<tr>
<td headers="Time" class="gt_row gt_right">4</td>
<td headers="Treatment" class="gt_row gt_left">SOC_TRT1_TRT3</td>
<td headers="n" class="gt_row gt_right">4</td>
</tr>
<tr>
<td headers="Time" class="gt_row gt_right">4</td>
<td headers="Treatment" class="gt_row gt_left">SOC_TRT1_TRT3_TRT2</td>
<td headers="n" class="gt_row gt_right">4</td>
</tr>
<tr>
<td headers="Time" class="gt_row gt_right">8</td>
<td headers="Treatment" class="gt_row gt_left">SOC_TRT1</td>
<td headers="n" class="gt_row gt_right">3</td>
</tr>
<tr>
<td headers="Time" class="gt_row gt_right">8</td>
<td headers="Treatment" class="gt_row gt_left">SOC_TRT1_TRT2</td>
<td headers="n" class="gt_row gt_right">3</td>
</tr>
<tr>
<td headers="Time" class="gt_row gt_right">8</td>
<td headers="Treatment" class="gt_row gt_left">SOC_TRT1_TRT3</td>
<td headers="n" class="gt_row gt_right">4</td>
</tr>
<tr>
<td headers="Time" class="gt_row gt_right">8</td>
<td headers="Treatment" class="gt_row gt_left">SOC_TRT1_TRT3_TRT2</td>
<td headers="n" class="gt_row gt_right">4</td>
</tr>
</tbody>
</table>
</div>
<p>Total number of samples is: 32</p>
</div>
<div class="section level2">
<h2 id="task">Task<a class="anchor" aria-label="anchor" href="#task"></a>
</h2>
<p>Samples are to be blocked in batches for scRNA-seq.</p>
<ul>
<li>8 samples can be processed per day (batch)</li>
<li>Within day they need to be split into 2 parallel runs (4 + 4).</li>
</ul>
<p>This data set is also used in the nested dimensions example. Here, we
focus on using different methods for the optimization.</p>
</div>
<div class="section level2">
<h2 id="setting-up-batch-container">Setting up batch container<a class="anchor" aria-label="anchor" href="#setting-up-batch-container"></a>
</h2>
<p>We allocate surplus positions in the batch container and some
excluded positions to check that all optimization methods support empty
container positions.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Setting up the batch container</span></span>
<span><span class="va">bc</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/BatchContainer.html">BatchContainer</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  dimensions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    batch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">multi_trt_day_samples</span><span class="op">)</span> <span class="op">/</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>    run <span class="op">=</span> <span class="fl">2</span>, position <span class="op">=</span> <span class="fl">5</span></span>
<span>  <span class="op">)</span>,</span>
<span>  exclude <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>batch <span class="op">=</span> <span class="fl">4</span>, run <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add samples to container</span></span>
<span><span class="fu"><a href="../reference/assign_in_order.html">assign_in_order</a></span><span class="op">(</span><span class="va">bc</span>, samples <span class="op">=</span> <span class="va">multi_trt_day_samples</span><span class="op">)</span></span>
<span><span class="co"># Set scoring function</span></span>
<span><span class="va">bc</span><span class="op">$</span><span class="va">scoring_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/osat_score_generator.html">osat_score_generator</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"batch"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treatment"</span>, <span class="st">"Time"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bc</span></span>
<span><span class="co">#&gt; Batch container with 38 locations and 32 samples (assigned).</span></span>
<span><span class="co">#&gt;   Dimensions: batch, run, position</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="first-optimization-with-fixed-shuffling-protocol">First optimization with fixed shuffling protocol<a class="anchor" aria-label="anchor" href="#first-optimization-with-fixed-shuffling-protocol"></a>
</h2>
<p>The samples are distributed to 4 batches (processing days). We use
the osat scoring on sample <code>Treatment</code> and <code>Time</code>,
using first a shuffling protocol with a fixed number of sample swaps on
each iteration.</p>
<p>Note that doing 32 swaps on 38 free container positions does not make
sense, since each swapping operation affects two different positions
anyway. The upper limit is reduced to the max number of meaningful swaps
(19) on the fly.</p>
<p>Optimization finishes after the list of permutations is
exhausted.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_shuffle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">10</span>, <span class="fl">5</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">40</span>, <span class="fl">40</span>, <span class="fl">50</span>, <span class="fl">50</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">bc1</span> <span class="op">&lt;-</span> <span class="va">bc</span><span class="op">$</span><span class="fu">copy</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">trace1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optimize_design.html">optimize_design</a></span><span class="op">(</span></span>
<span>  <span class="va">bc1</span>,</span>
<span>  n_shuffle <span class="op">=</span> <span class="va">n_shuffle</span> <span class="co"># will implicitly generate a shuffling function according to the provided schedule</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Re-defined number of swaps to 19 in swapping function.</span></span>
<span><span class="co">#&gt; Warning in osat_score(bc, batch_vars = batch_vars, feature_vars = feature_vars,</span></span>
<span><span class="co">#&gt; : NAs in features / batch columns; they will be excluded from scoring</span></span>
<span><span class="co">#&gt; Checking variances of 1-dim. score vector.</span></span>
<span><span class="co">#&gt; ... (25.046) - OK</span></span>
<span><span class="co">#&gt; Initial score: 73.03</span></span>
<span><span class="co">#&gt; Achieved score: 20.925 at iteration 1</span></span>
<span><span class="co">#&gt; Achieved score: 20.399 at iteration 5</span></span>
<span><span class="co">#&gt; Achieved score: 18.82 at iteration 7</span></span>
<span><span class="co">#&gt; Achieved score: 18.294 at iteration 9</span></span>
<span><span class="co">#&gt; Achieved score: 17.346 at iteration 13</span></span>
<span><span class="co">#&gt; Achieved score: 12.82 at iteration 21</span></span>
<span><span class="co">#&gt; Achieved score: 10.925 at iteration 22</span></span>
<span><span class="co">#&gt; Achieved score: 6.82 at iteration 49</span></span>
<span><span class="co">#&gt; Achieved score: 4.82 at iteration 85</span></span>
<span><span class="co">#&gt; Achieved score: 4.504 at iteration 174</span></span>
<span></span>
<span><span class="va">trace1</span><span class="op">$</span><span class="va">elapsed</span></span>
<span><span class="co">#&gt; Time difference of 2.559221 secs</span></span></code></pre></div>
<div class="section level3">
<h3 id="optimization-trace">Optimization trace<a class="anchor" aria-label="anchor" href="#optimization-trace"></a>
</h3>
<p>Custom plot with some colours:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/qplot.html" class="external-link">qplot</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">trace1</span><span class="op">$</span><span class="va">scores</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">trace1</span><span class="op">$</span><span class="va">scores</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">n_shuffle</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">trace1</span><span class="op">$</span><span class="va">scores</span><span class="op">)</span><span class="op">]</span>, geom <span class="op">=</span> <span class="st">"point"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Score 1 tracing"</span>, subtitle <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html" class="external-link">str_glue</a></span><span class="op">(</span><span class="st">"Final score = {bc1$score()}"</span><span class="op">)</span>, x <span class="op">=</span> <span class="st">"Iteration"</span>, y <span class="op">=</span> <span class="st">"Score"</span>, color <span class="op">=</span> <span class="st">"n_shuffle"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: `qplot()` was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span></code></pre></div>
<p><img src="optimizer_examples_files/figure-html/unnamed-chunk-6-1.png" width="480"></p>
<p>Using the internal method…</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trace1</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="optimizer_examples_files/figure-html/unnamed-chunk-7-1.png" width="480"></p>
<p>We may safely apply the batch container methods get_samples() and
score() also after using the new optimization code.</p>
</div>
<div class="section level3">
<h3 id="final-batch-layout">Final batch layout<a class="anchor" aria-label="anchor" href="#final-batch-layout"></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bc1</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 4.504155</span></span>
<span></span>
<span><span class="va">bc1</span><span class="op">$</span><span class="fu">get_samples</span><span class="op">(</span>assignment <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Treatment</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>anno <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="va">Time</span>, <span class="st">" hr"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">batch</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html" class="external-link">interaction</a></span><span class="op">(</span><span class="va">position</span>, <span class="va">run</span><span class="op">)</span>, fill <span class="op">=</span> <span class="va">Treatment</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">5.5</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">anno</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Batch"</span>, y <span class="op">=</span> <span class="st">"Position . Run"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use `linewidth` instead.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span></code></pre></div>
<p><img src="optimizer_examples_files/figure-html/unnamed-chunk-8-1.png" width="576"></p>
</div>
<div class="section level3">
<h3 id="perform-new-iterations-on-optimized-batch-container">Perform new iterations on optimized batch container<a class="anchor" aria-label="anchor" href="#perform-new-iterations-on-optimized-batch-container"></a>
</h3>
<p>Further optimization (using a different shuffling protocol maybe) can
be done immediately on the same batch container.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_shuffle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">30</span>, <span class="fl">30</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/optimize_design.html">optimize_design</a></span><span class="op">(</span></span>
<span>  <span class="va">bc1</span>,</span>
<span>  n_shuffle <span class="op">=</span> <span class="va">n_shuffle</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Checking variances of 1-dim. score vector.</span></span>
<span><span class="co">#&gt; ... (24.63) - OK</span></span>
<span><span class="co">#&gt; Initial score: 4.504</span></span>
<span><span class="co">#&gt; Achieved score: 2.609 at iteration 88</span></span>
<span><span class="co">#&gt; Optimization trace (91 score values, elapsed 1.469071 secs).</span></span>
<span><span class="co">#&gt;   Starting score: 4.504</span></span>
<span><span class="co">#&gt;   Final score   : 2.609</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="optimization-with-specified-stopping-criteria">Optimization with specified stopping criteria<a class="anchor" aria-label="anchor" href="#optimization-with-specified-stopping-criteria"></a>
</h2>
<p>Starting optimization from scratch, we are passing now some stopping
criteria that may terminate optimization before a shuffling protocol has
been exhausted.</p>
<p>For demonstration, we use a shuffling function now that will do 3
sample (position) swaps per iteration and can be called an arbitrary
number of times. Thus, iteration has to be stopped by either the
max_iter criterion or by reaching a specific minimum delta threshold
(score improvement from one selected solution to the next).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bc2</span> <span class="op">&lt;-</span> <span class="va">bc</span><span class="op">$</span><span class="fu">copy</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/optimize_design.html">optimize_design</a></span><span class="op">(</span></span>
<span>  <span class="va">bc2</span>,</span>
<span>  n_shuffle <span class="op">=</span> <span class="fl">3</span>, <span class="co"># will implicitly generate a shuffling function that will do 3 swaps at each iteration</span></span>
<span>  max_iter <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>  min_delta <span class="op">=</span> <span class="fl">0.1</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Checking variances of 1-dim. score vector.</span></span>
<span><span class="co">#&gt; ... (29.544) - OK</span></span>
<span><span class="co">#&gt; Initial score: 73.03</span></span>
<span><span class="co">#&gt; Achieved score: 67.662 at iteration 1</span></span>
<span><span class="co">#&gt; Achieved score: 54.083 at iteration 2</span></span>
<span><span class="co">#&gt; Achieved score: 38.083 at iteration 3</span></span>
<span><span class="co">#&gt; Achieved score: 36.504 at iteration 4</span></span>
<span><span class="co">#&gt; Achieved score: 34.715 at iteration 5</span></span>
<span><span class="co">#&gt; Achieved score: 30.715 at iteration 6</span></span>
<span><span class="co">#&gt; Achieved score: 28.715 at iteration 7</span></span>
<span><span class="co">#&gt; Achieved score: 26.715 at iteration 8</span></span>
<span><span class="co">#&gt; Achieved score: 22.715 at iteration 9</span></span>
<span><span class="co">#&gt; Achieved score: 14.294 at iteration 11</span></span>
<span><span class="co">#&gt; Achieved score: 12.294 at iteration 27</span></span>
<span><span class="co">#&gt; Achieved score: 12.083 at iteration 29</span></span>
<span><span class="co">#&gt; Achieved score: 8.188 at iteration 66</span></span>
<span><span class="co">#&gt; Achieved score: 6.188 at iteration 109</span></span>
<span><span class="co">#&gt; Achieved score: 4.188 at iteration 146</span></span>
<span><span class="co">#&gt; Achieved score: 2.609 at iteration 334</span></span>
<span><span class="co">#&gt; Achieved score: 2.294 at iteration 621</span></span>
<span><span class="co">#&gt; Optimization trace (2001 score values, elapsed 16.78205 secs).</span></span>
<span><span class="co">#&gt;   Starting score: 73.03</span></span>
<span><span class="co">#&gt;   Final score   : 2.294</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="optimization-with-multi-variate-scoring-function">Optimization with multi-variate scoring function<a class="anchor" aria-label="anchor" href="#optimization-with-multi-variate-scoring-function"></a>
</h2>
<p>Instead of passing a single scoring function, a list of multiple
scoring functions can be assigned to a batch container, each of which to
return a scalar value on evaluation.</p>
<p>By default, a strict improvement rule is applied for classifying a
potential solution as “better”: each of the individual scores has to be
smaller than or equal to its previous value, and one of the scores has
to be changed.</p>
<p>However, the user could specify other methods for aggregating the
scores or defining the acceptance criterion. See later examples.</p>
<p>The second scoring function used here is by the way rather redundant
and just serves for illustration.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bc3</span> <span class="op">&lt;-</span> <span class="va">bc</span><span class="op">$</span><span class="fu">copy</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bc3</span><span class="op">$</span><span class="va">scoring_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/osat_score_generator.html">osat_score_generator</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"batch"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treatment"</span>, <span class="st">"Time"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/osat_score_generator.html">osat_score_generator</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"batch"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treatment"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">trace</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optimize_design.html">optimize_design</a></span><span class="op">(</span></span>
<span>  <span class="va">bc3</span>,</span>
<span>  n_shuffle <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  max_iter <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  min_delta <span class="op">=</span> <span class="fl">0.1</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in osat_score(bc, batch_vars = batch_vars, feature_vars = feature_vars,</span></span>
<span><span class="co">#&gt; : NAs in features / batch columns; they will be excluded from scoring</span></span>
<span></span>
<span><span class="co">#&gt; Warning in osat_score(bc, batch_vars = batch_vars, feature_vars = feature_vars,</span></span>
<span><span class="co">#&gt; : NAs in features / batch columns; they will be excluded from scoring</span></span>
<span><span class="co">#&gt; Checking variances of 2-dim. score vector.</span></span>
<span><span class="co">#&gt; ... (27.086, 53.151) - OK</span></span>
<span><span class="co">#&gt; Initial score: c(73.03, 44.803)</span></span>
<span><span class="co">#&gt; Achieved score: c(51.452, 39.645) at iteration 2</span></span>
<span><span class="co">#&gt; Achieved score: c(35.452, 29.645) at iteration 3</span></span>
<span><span class="co">#&gt; Achieved score: c(29.662, 25.751) at iteration 5</span></span>
<span><span class="co">#&gt; Achieved score: c(25.662, 21.751) at iteration 6</span></span>
<span><span class="co">#&gt; Achieved score: c(23.978, 14.382) at iteration 16</span></span>
<span><span class="co">#&gt; Achieved score: c(14.399, 9.119) at iteration 20</span></span>
<span><span class="co">#&gt; Achieved score: c(12.504, 7.33) at iteration 22</span></span>
<span><span class="co">#&gt; Achieved score: c(10.504, 7.33) at iteration 31</span></span>
<span><span class="co">#&gt; Achieved score: c(10.504, 5.751) at iteration 45</span></span>
<span><span class="co">#&gt; Achieved score: c(6.504, 5.751) at iteration 66</span></span>
<span><span class="co">#&gt; Achieved score: c(4.925, 4.593) at iteration 136</span></span>
<span><span class="co">#&gt; Achieved score: c(4.925, 4.593) at iteration 179</span></span>
<span><span class="co">#&gt; Reached min delta in 179 iterations.</span></span></code></pre></div>
<p>Note that the first score tends to yield higher values than the
second one. This could be a problem when trying to select a solution
based on an aggregated, overall score. We repeat the same optimization
now by using the autoscaling functionality of the optimizer.</p>
</div>
<div class="section level2">
<h2 id="auto-scaling-scores">Auto-scaling scores<a class="anchor" aria-label="anchor" href="#auto-scaling-scores"></a>
</h2>
<p>We’re just adding the <code>autoscale_scores</code> option here to
estimate the distribution of individual scores on a number of completely
random sample assignments (200 in this case) and then apply a
transformation to rescale each score to a standard normal.</p>
<p>Note that by ‘normalizing’ the distribution of the scores we obtain
values centered around zero, thus that the optimized scores are likely
to be negative. We may also want to decrease the delta_min parameter to
match the new numerical range.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bc3_as</span> <span class="op">&lt;-</span> <span class="va">bc</span><span class="op">$</span><span class="fu">copy</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bc3_as</span><span class="op">$</span><span class="va">scoring_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/osat_score_generator.html">osat_score_generator</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"batch"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treatment"</span>, <span class="st">"Time"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/osat_score_generator.html">osat_score_generator</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"batch"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treatment"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">trace</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optimize_design.html">optimize_design</a></span><span class="op">(</span></span>
<span>  <span class="va">bc3_as</span>,</span>
<span>  n_shuffle <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  max_iter <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  min_delta <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>  autoscale_scores <span class="op">=</span> <span class="cn">T</span>,</span>
<span>  autoscaling_permutations <span class="op">=</span> <span class="fl">200</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in osat_score(bc, batch_vars = batch_vars, feature_vars = feature_vars,</span></span>
<span><span class="co">#&gt; : NAs in features / batch columns; they will be excluded from scoring</span></span>
<span></span>
<span><span class="co">#&gt; Warning in osat_score(bc, batch_vars = batch_vars, feature_vars = feature_vars,</span></span>
<span><span class="co">#&gt; : NAs in features / batch columns; they will be excluded from scoring</span></span>
<span><span class="co">#&gt; Checking variances of 2-dim. score vector.</span></span>
<span><span class="co">#&gt; ... (33.045, 64.702) - OK</span></span>
<span><span class="co">#&gt; Creating autoscaling function for 2-dim. score vector. (200 random permutations)</span></span>
<span><span class="co">#&gt; ... Performing boxcox lambda estimation.</span></span>
<span><span class="co">#&gt; Initial score: c(5.727, 2.888)</span></span>
<span><span class="co">#&gt; Achieved score: c(3.589, 1.885) at iteration 1</span></span>
<span><span class="co">#&gt; Achieved score: c(2.74, 1.253) at iteration 2</span></span>
<span><span class="co">#&gt; Achieved score: c(1.948, 0.953) at iteration 3</span></span>
<span><span class="co">#&gt; Achieved score: c(-0.026, 0.296) at iteration 4</span></span>
<span><span class="co">#&gt; Achieved score: c(-1.029, -0.621) at iteration 6</span></span>
<span><span class="co">#&gt; Achieved score: c(-2.022, -1.418) at iteration 14</span></span>
<span><span class="co">#&gt; Achieved score: c(-3.505, -2.281) at iteration 28</span></span>
<span><span class="co">#&gt; Achieved score: c(-3.505, -2.307) at iteration 40</span></span>
<span><span class="co">#&gt; Achieved score: c(-4.252, -2.598) at iteration 56</span></span>
<span><span class="co">#&gt; Achieved score: c(-5.705, -2.8) at iteration 76</span></span>
<span><span class="co">#&gt; Achieved score: c(-7.415, -2.8) at iteration 92</span></span></code></pre></div>
<p>Having directly comparable scores, it may be reasonable now to use a
function that somehow aggregates the scores to decide on the best
iteration (instead of looking at the scores individually).</p>
<p>An easy way to do this is to use the built-in worst_score function.
This will simply set the aggregated score to whichever of the individual
scores is larger (i.e. ‘worse’ in terms of the optimization).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bc4</span> <span class="op">&lt;-</span> <span class="va">bc</span><span class="op">$</span><span class="fu">copy</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bc4</span><span class="op">$</span><span class="va">scoring_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/osat_score_generator.html">osat_score_generator</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"batch"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treatment"</span>, <span class="st">"Time"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/osat_score_generator.html">osat_score_generator</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"batch"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treatment"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="../reference/optimize_design.html">optimize_design</a></span><span class="op">(</span></span>
<span>  <span class="va">bc4</span>,</span>
<span>  n_shuffle <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  aggregate_scores_func <span class="op">=</span> <span class="va">worst_score</span>,</span>
<span>  max_iter <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  autoscale_scores <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  autoscaling_permutations <span class="op">=</span> <span class="fl">200</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in osat_score(bc, batch_vars = batch_vars, feature_vars = feature_vars,</span></span>
<span><span class="co">#&gt; : NAs in features / batch columns; they will be excluded from scoring</span></span>
<span></span>
<span><span class="co">#&gt; Warning in osat_score(bc, batch_vars = batch_vars, feature_vars = feature_vars,</span></span>
<span><span class="co">#&gt; : NAs in features / batch columns; they will be excluded from scoring</span></span>
<span><span class="co">#&gt; Checking variances of 2-dim. score vector.</span></span>
<span><span class="co">#&gt; ... (23.096, 45.492) - OK</span></span>
<span><span class="co">#&gt; Creating autoscaling function for 2-dim. score vector. (200 random permutations)</span></span>
<span><span class="co">#&gt; ... Performing boxcox lambda estimation.</span></span>
<span><span class="co">#&gt; Initial score: c(7.044, 2.491)</span></span>
<span><span class="co">#&gt;    Aggregated: 7.044</span></span>
<span><span class="co">#&gt; Achieved score: c(3.972, 0.497) at iteration 1</span></span>
<span><span class="co">#&gt;    Aggregated: 3.972</span></span>
<span><span class="co">#&gt; Achieved score: c(3.958, 0.952) at iteration 2</span></span>
<span><span class="co">#&gt;    Aggregated: 3.958</span></span>
<span><span class="co">#&gt; Achieved score: c(1.999, -0.642) at iteration 3</span></span>
<span><span class="co">#&gt;    Aggregated: 1.999</span></span>
<span><span class="co">#&gt; Achieved score: c(1.752, -1.588) at iteration 4</span></span>
<span><span class="co">#&gt;    Aggregated: 1.752</span></span>
<span><span class="co">#&gt; Achieved score: c(1.17, -1.421) at iteration 6</span></span>
<span><span class="co">#&gt;    Aggregated: 1.17</span></span>
<span><span class="co">#&gt; Achieved score: c(-0.265, -3.156) at iteration 7</span></span>
<span><span class="co">#&gt;    Aggregated: -0.265</span></span>
<span><span class="co">#&gt; Achieved score: c(-0.64, -1.87) at iteration 8</span></span>
<span><span class="co">#&gt;    Aggregated: -0.64</span></span>
<span><span class="co">#&gt; Achieved score: c(-1.516, -1.029) at iteration 11</span></span>
<span><span class="co">#&gt;    Aggregated: -1.029</span></span>
<span><span class="co">#&gt; Achieved score: c(-1.492, -1.398) at iteration 14</span></span>
<span><span class="co">#&gt;    Aggregated: -1.398</span></span>
<span><span class="co">#&gt; Achieved score: c(-1.882, -1.79) at iteration 48</span></span>
<span><span class="co">#&gt;    Aggregated: -1.79</span></span>
<span><span class="co">#&gt; Achieved score: c(-2.349, -2.18) at iteration 50</span></span>
<span><span class="co">#&gt;    Aggregated: -2.18</span></span>
<span><span class="co">#&gt; Achieved score: c(-2.376, -2.995) at iteration 58</span></span>
<span><span class="co">#&gt;    Aggregated: -2.376</span></span>
<span><span class="co">#&gt; Achieved score: c(-2.403, -3.917) at iteration 67</span></span>
<span><span class="co">#&gt;    Aggregated: -2.403</span></span>
<span><span class="co">#&gt; Achieved score: c(-2.403, -3.917) at iteration 83</span></span>
<span><span class="co">#&gt;    Aggregated: -2.403</span></span>
<span><span class="co">#&gt; Achieved score: c(-2.431, -4.029) at iteration 132</span></span>
<span><span class="co">#&gt;    Aggregated: -2.431</span></span>
<span><span class="co">#&gt; Achieved score: c(-3.093, -2.697) at iteration 143</span></span>
<span><span class="co">#&gt;    Aggregated: -2.697</span></span>
<span><span class="co">#&gt; Achieved score: c(-3.676, -3.417) at iteration 151</span></span>
<span><span class="co">#&gt;    Aggregated: -3.417</span></span>
<span><span class="co">#&gt; Optimization trace (201 score values, elapsed 6.154244 secs).</span></span>
<span><span class="co">#&gt;   Starting score: 7.044,2.491</span></span>
<span><span class="co">#&gt;   Final score   : -3.676,-3.417</span></span></code></pre></div>
<p>Another - more interesting - option would be to aggregate the two
scores by taking their sum. This way both scores will influence the
optimization at every step.</p>
<p>For illustration, we omit the <code>n_shuffle</code> parameter here,
which will lead by default to pairwise sample swaps being done on each
iteration.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bc5</span> <span class="op">&lt;-</span> <span class="va">bc</span><span class="op">$</span><span class="fu">copy</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bc5</span><span class="op">$</span><span class="va">scoring_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/osat_score_generator.html">osat_score_generator</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"batch"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treatment"</span>, <span class="st">"Time"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/osat_score_generator.html">osat_score_generator</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"batch"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treatment"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/optimize_design.html">optimize_design</a></span><span class="op">(</span></span>
<span>  <span class="va">bc5</span>,</span>
<span>  aggregate_scores_func <span class="op">=</span> <span class="va">sum_scores</span>,</span>
<span>  max_iter <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  autoscale_scores <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  autoscaling_permutations <span class="op">=</span> <span class="fl">200</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>As a final example, we calculate the (squared) L2 norm to actually
aggregate the two scores. Not that this choice is not really motivated
in this case, but it could be used if optimization was carried on
meaningful distance vectors or normalized n-tuples.</p>
<p>Note that we don’t use the auto-scaling in this case as the L2-norm
based optimization would force both normalized scores towards zero, not
the minimal (negative) value that would be desired in that case.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bc5_2</span> <span class="op">&lt;-</span> <span class="va">bc</span><span class="op">$</span><span class="fu">copy</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bc5_2</span><span class="op">$</span><span class="va">scoring_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/osat_score_generator.html">osat_score_generator</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"batch"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treatment"</span>, <span class="st">"Time"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/osat_score_generator.html">osat_score_generator</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"batch"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treatment"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/optimize_design.html">optimize_design</a></span><span class="op">(</span></span>
<span>  <span class="va">bc5_2</span>,</span>
<span>  aggregate_scores_func <span class="op">=</span> <span class="va">L2s_norm</span>,</span>
<span>  max_iter <span class="op">=</span> <span class="fl">200</span>,</span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="passing-a-customized-shuffling-function">Passing a customized shuffling function<a class="anchor" aria-label="anchor" href="#passing-a-customized-shuffling-function"></a>
</h2>
<p>It is recommended to use the <code>n_shuffle</code> parameter to
steer the optimization protocol. However, you may also provide a
dedicated shuffling function that on each call has to return a shuffling
order (as integer vector) or a list with the source and destination
positions (src and dst) of the sample positions to be swapped.</p>
<p>The following example uses a template for creating complete random
shuffles across all available positions in the batch container. Note
that this is usually not a good strategy for converging to a
solution.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bc6</span> <span class="op">&lt;-</span> <span class="va">bc</span><span class="op">$</span><span class="fu">copy</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/optimize_design.html">optimize_design</a></span><span class="op">(</span></span>
<span>  <span class="va">bc6</span>,</span>
<span>  shuffle_proposal_func <span class="op">=</span> <span class="va">complete_random_shuffling</span>,</span>
<span>  max_iter <span class="op">=</span> <span class="fl">200</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Checking variances of 1-dim. score vector.</span></span>
<span><span class="co">#&gt; ... (31.558) - OK</span></span>
<span><span class="co">#&gt; Initial score: 73.03</span></span>
<span><span class="co">#&gt; Achieved score: 32.925 at iteration 1</span></span>
<span><span class="co">#&gt; Achieved score: 19.241 at iteration 2</span></span>
<span><span class="co">#&gt; Achieved score: 15.978 at iteration 4</span></span>
<span><span class="co">#&gt; Achieved score: 12.925 at iteration 24</span></span>
<span><span class="co">#&gt; Achieved score: 12.82 at iteration 25</span></span>
<span><span class="co">#&gt; Achieved score: 10.399 at iteration 34</span></span>
<span><span class="co">#&gt; Achieved score: 8.82 at iteration 87</span></span>
<span><span class="co">#&gt; Optimization trace (201 score values, elapsed 1.999838 secs).</span></span>
<span><span class="co">#&gt;   Starting score: 73.03</span></span>
<span><span class="co">#&gt;   Final score   : 8.82</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-simulated-annealing-sa-for-optimization">Using simulated annealing (SA) for optimization<a class="anchor" aria-label="anchor" href="#using-simulated-annealing-sa-for-optimization"></a>
</h2>
<p>Esp. for very large search spaces, better solutions can be quite
successfully obtained by a SA protocol which allows the optimizer to
jump over ‘energy barriers’ to more likely converge at lower local
minima.</p>
<p>The optimizer usually remembers the permutation with the best overall
score to start with, but this behavior can be changed by supplying a
simulated annealing protocol, most simply by generating a ready-made
function template.</p>
<p>It is generally recommended for SA to make small changes at each
step, like allowing just 1 sample swap per iteration.</p>
<p>Currently the simulated annealing protocol requires a single double
value score to be optimized. Choose an appropriate aggregation function
if you happen to have multiple scores initially.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bc7</span> <span class="op">&lt;-</span> <span class="va">bc</span><span class="op">$</span><span class="fu">copy</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">trace7</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optimize_design.html">optimize_design</a></span><span class="op">(</span></span>
<span>  <span class="va">bc7</span>,</span>
<span>  n_shuffle <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  acceptance_func <span class="op">=</span> <span class="fu"><a href="../reference/mk_simanneal_acceptance_func.html">mk_simanneal_acceptance_func</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  max_iter <span class="op">=</span> <span class="fl">200</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Checking variances of 1-dim. score vector.</span></span>
<span><span class="co">#&gt; ... (26.224) - OK</span></span>
<span><span class="co">#&gt; Initial score: 73.03</span></span>
<span><span class="co">#&gt; Achieved score: 67.452 at iteration 1</span></span>
<span><span class="co">#&gt; Achieved score: 67.452 at iteration 2</span></span>
<span><span class="co">#&gt; Achieved score: 67.452 at iteration 3</span></span>
<span><span class="co">#&gt; Achieved score: 67.452 at iteration 4</span></span>
<span><span class="co">#&gt; Achieved score: 67.452 at iteration 5</span></span>
<span><span class="co">#&gt; Achieved score: 65.452 at iteration 6</span></span>
<span><span class="co">#&gt; Achieved score: 55.452 at iteration 7</span></span>
<span><span class="co">#&gt; Achieved score: 49.873 at iteration 8</span></span>
<span><span class="co">#&gt; Achieved score: 43.873 at iteration 9</span></span>
<span><span class="co">#&gt; Achieved score: 43.873 at iteration 10</span></span>
<span><span class="co">#&gt; Achieved score: 43.873 at iteration 11</span></span>
<span><span class="co">#&gt; Achieved score: 41.873 at iteration 14</span></span>
<span><span class="co">#&gt; Achieved score: 37.767 at iteration 15</span></span>
<span><span class="co">#&gt; Achieved score: 35.767 at iteration 16</span></span>
<span><span class="co">#&gt; Achieved score: 35.767 at iteration 17</span></span>
<span><span class="co">#&gt; Achieved score: 35.767 at iteration 18</span></span>
<span><span class="co">#&gt; Achieved score: 31.767 at iteration 19</span></span>
<span><span class="co">#&gt; Achieved score: 28.083 at iteration 20</span></span>
<span><span class="co">#&gt; Achieved score: 26.188 at iteration 21</span></span>
<span><span class="co">#&gt; Achieved score: 26.188 at iteration 23</span></span>
<span><span class="co">#&gt; Achieved score: 24.188 at iteration 24</span></span>
<span><span class="co">#&gt; Achieved score: 22.188 at iteration 25</span></span>
<span><span class="co">#&gt; Achieved score: 24.188 at iteration 26</span></span>
<span><span class="co">#&gt; Achieved score: 24.083 at iteration 27</span></span>
<span><span class="co">#&gt; Achieved score: 24.083 at iteration 28</span></span>
<span><span class="co">#&gt; Achieved score: 20.083 at iteration 29</span></span>
<span><span class="co">#&gt; Achieved score: 18.083 at iteration 30</span></span>
<span><span class="co">#&gt; Achieved score: 18.083 at iteration 31</span></span>
<span><span class="co">#&gt; Achieved score: 18.083 at iteration 33</span></span>
<span><span class="co">#&gt; Achieved score: 16.083 at iteration 38</span></span>
<span><span class="co">#&gt; Achieved score: 16.083 at iteration 40</span></span>
<span><span class="co">#&gt; Achieved score: 16.083 at iteration 49</span></span>
<span><span class="co">#&gt; Achieved score: 14.083 at iteration 51</span></span>
<span><span class="co">#&gt; Achieved score: 14.083 at iteration 52</span></span>
<span><span class="co">#&gt; Achieved score: 14.399 at iteration 54</span></span>
<span><span class="co">#&gt; Achieved score: 14.399 at iteration 61</span></span>
<span><span class="co">#&gt; Achieved score: 14.399 at iteration 62</span></span>
<span><span class="co">#&gt; Achieved score: 12.399 at iteration 63</span></span>
<span><span class="co">#&gt; Achieved score: 12.399 at iteration 64</span></span>
<span><span class="co">#&gt; Achieved score: 12.399 at iteration 68</span></span>
<span><span class="co">#&gt; Achieved score: 12.399 at iteration 69</span></span>
<span><span class="co">#&gt; Achieved score: 12.399 at iteration 74</span></span>
<span><span class="co">#&gt; Achieved score: 10.82 at iteration 80</span></span>
<span><span class="co">#&gt; Achieved score: 10.82 at iteration 82</span></span>
<span><span class="co">#&gt; Achieved score: 8.82 at iteration 86</span></span>
<span><span class="co">#&gt; Achieved score: 8.82 at iteration 109</span></span>
<span><span class="co">#&gt; Achieved score: 6.82 at iteration 122</span></span>
<span><span class="co">#&gt; Achieved score: 4.82 at iteration 124</span></span></code></pre></div>
<p>The trace may show a non strictly monotonic behavior now, reflecting
the SA protocol at work.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trace7</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="optimizer_examples_files/figure-html/unnamed-chunk-18-1.png" width="480"></p>
<p>Better results and quicker convergence may be achieved by playing
with the starting temperature (T0) and cooling speed (alpha) in a
specific case.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bc8</span> <span class="op">&lt;-</span> <span class="va">bc</span><span class="op">$</span><span class="fu">copy</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">trace8</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optimize_design.html">optimize_design</a></span><span class="op">(</span></span>
<span>  <span class="va">bc8</span>,</span>
<span>  n_shuffle <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  acceptance_func <span class="op">=</span> <span class="fu"><a href="../reference/mk_simanneal_acceptance_func.html">mk_simanneal_acceptance_func</a></span><span class="op">(</span><span class="fu"><a href="../reference/mk_simanneal_temp_func.html">mk_simanneal_temp_func</a></span><span class="op">(</span>T0 <span class="op">=</span> <span class="fl">100</span>, alpha <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  max_iter <span class="op">=</span> <span class="fl">150</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Checking variances of 1-dim. score vector.</span></span>
<span><span class="co">#&gt; ... (34.519) - OK</span></span>
<span><span class="co">#&gt; Initial score: 73.03</span></span>
<span><span class="co">#&gt; Achieved score: 73.03 at iteration 1</span></span>
<span><span class="co">#&gt; Achieved score: 69.03 at iteration 2</span></span>
<span><span class="co">#&gt; Achieved score: 61.03 at iteration 3</span></span>
<span><span class="co">#&gt; Achieved score: 61.03 at iteration 4</span></span>
<span><span class="co">#&gt; Achieved score: 55.03 at iteration 5</span></span>
<span><span class="co">#&gt; Achieved score: 49.03 at iteration 6</span></span>
<span><span class="co">#&gt; Achieved score: 49.03 at iteration 7</span></span>
<span><span class="co">#&gt; Achieved score: 43.03 at iteration 9</span></span>
<span><span class="co">#&gt; Achieved score: 33.03 at iteration 10</span></span>
<span><span class="co">#&gt; Achieved score: 23.03 at iteration 11</span></span>
<span><span class="co">#&gt; Achieved score: 23.03 at iteration 12</span></span>
<span><span class="co">#&gt; Achieved score: 23.03 at iteration 14</span></span>
<span><span class="co">#&gt; Achieved score: 21.03 at iteration 15</span></span>
<span><span class="co">#&gt; Achieved score: 21.03 at iteration 17</span></span>
<span><span class="co">#&gt; Achieved score: 19.03 at iteration 18</span></span>
<span><span class="co">#&gt; Achieved score: 17.03 at iteration 21</span></span>
<span><span class="co">#&gt; Achieved score: 17.03 at iteration 28</span></span>
<span><span class="co">#&gt; Achieved score: 17.03 at iteration 35</span></span>
<span><span class="co">#&gt; Achieved score: 13.03 at iteration 37</span></span>
<span><span class="co">#&gt; Achieved score: 11.03 at iteration 42</span></span>
<span><span class="co">#&gt; Achieved score: 10.925 at iteration 45</span></span>
<span><span class="co">#&gt; Achieved score: 9.346 at iteration 60</span></span>
<span><span class="co">#&gt; Achieved score: 7.346 at iteration 62</span></span>
<span><span class="co">#&gt; Achieved score: 5.452 at iteration 86</span></span>
<span><span class="co">#&gt; Achieved score: 3.873 at iteration 140</span></span>
<span></span>
<span><span class="va">trace8</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="optimizer_examples_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="full-blown-example">Full blown example<a class="anchor" aria-label="anchor" href="#full-blown-example"></a>
</h2>
<p>The following example puts together all possible options to
illustrate the flexibility of the optimization.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bc</span><span class="op">$</span><span class="va">scoring_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/osat_score_generator.html">osat_score_generator</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"batch"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treatment"</span>, <span class="st">"Time"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/osat_score_generator.html">osat_score_generator</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"batch"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treatment"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/osat_score_generator.html">osat_score_generator</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"batch"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Time"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_shuffle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">20</span>, <span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">trace</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optimize_design.html">optimize_design</a></span><span class="op">(</span></span>
<span>  <span class="va">bc</span>,</span>
<span>  n_shuffle <span class="op">=</span> <span class="va">n_shuffle</span>,</span>
<span>  aggregate_scores_func <span class="op">=</span> <span class="va">sum_scores</span>,</span>
<span>  acceptance_func <span class="op">=</span> <span class="fu"><a href="../reference/mk_simanneal_acceptance_func.html">mk_simanneal_acceptance_func</a></span><span class="op">(</span><span class="fu"><a href="../reference/mk_simanneal_temp_func.html">mk_simanneal_temp_func</a></span><span class="op">(</span>T0 <span class="op">=</span> <span class="fl">500</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  max_iter <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  min_delta <span class="op">=</span> <span class="fl">1e-8</span>,</span>
<span>  autoscale_scores <span class="op">=</span> <span class="cn">T</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in osat_score(bc, batch_vars = batch_vars, feature_vars = feature_vars,</span></span>
<span><span class="co">#&gt; : NAs in features / batch columns; they will be excluded from scoring</span></span>
<span></span>
<span><span class="co">#&gt; Warning in osat_score(bc, batch_vars = batch_vars, feature_vars = feature_vars,</span></span>
<span><span class="co">#&gt; : NAs in features / batch columns; they will be excluded from scoring</span></span>
<span></span>
<span><span class="co">#&gt; Warning in osat_score(bc, batch_vars = batch_vars, feature_vars = feature_vars,</span></span>
<span><span class="co">#&gt; : NAs in features / batch columns; they will be excluded from scoring</span></span>
<span><span class="co">#&gt; Checking variances of 3-dim. score vector.</span></span>
<span><span class="co">#&gt; ... (24.506, 52.938, 67.784) - OK</span></span>
<span><span class="co">#&gt; Creating autoscaling function for 3-dim. score vector. (100 random permutations)</span></span>
<span><span class="co">#&gt; ... Performing boxcox lambda estimation.</span></span>
<span><span class="co">#&gt; Initial score: c(5.079, 2.547, 3.612)</span></span>
<span><span class="co">#&gt;    Aggregated: 11.238</span></span>
<span><span class="co">#&gt; Achieved score: c(4.084, 2.547, 2.882) at iteration 1</span></span>
<span><span class="co">#&gt;    Aggregated: 9.513</span></span>
<span><span class="co">#&gt; Achieved score: c(3.143, 1.774, 2.721) at iteration 2</span></span>
<span><span class="co">#&gt;    Aggregated: 7.638</span></span>
<span><span class="co">#&gt; Achieved score: c(2.081, 0.995, 2.004) at iteration 3</span></span>
<span><span class="co">#&gt;    Aggregated: 5.08</span></span>
<span><span class="co">#&gt; Achieved score: c(2.17, 1.726, 1.54) at iteration 4</span></span>
<span><span class="co">#&gt;    Aggregated: 5.437</span></span>
<span><span class="co">#&gt; Achieved score: c(1.376, 1.541, -0.098) at iteration 5</span></span>
<span><span class="co">#&gt;    Aggregated: 2.818</span></span>
<span><span class="co">#&gt; Achieved score: c(1.376, 1.541, -0.098) at iteration 6</span></span>
<span><span class="co">#&gt;    Aggregated: 2.818</span></span>
<span><span class="co">#&gt; Reached min delta in 6 iterations.</span></span>
<span></span>
<span><span class="va">trace</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="optimizer_examples_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">bc</span><span class="op">$</span><span class="fu">get_samples</span><span class="op">(</span>assignment <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>batch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">batch</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">batch</span>, fill <span class="op">=</span> <span class="va">Treatment</span>, alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Time</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Using alpha for a discrete variable is not advised.</span></span></code></pre></div>
<p><img src="optimizer_examples_files/figure-html/unnamed-chunk-20-2.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Iakov I. Davydov, Juliane Siebourg-Polster, Guido Steiner, Balazs Banfai.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
